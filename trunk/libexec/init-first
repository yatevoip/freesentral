#! /bin/sh

# freesentral-init executes this to fix some system settings and permissions

RETVAL=0

## Allow for restarting in case of kernel panic
f="/etc/sysctl.conf"
if ! fgrep -q 'kernel.panic' "$f"; then
    echo 'kernel.panic = 5' >> "$f"
    echo '5' > /proc/sys/kernel/panic
    RETVAL=1
fi

## Add the apache helper to allowed sudoers
f="/etc/sudoers"
if ! fgrep -q 'freesentral/ctl-root' "$f"; then
    echo -e '## Added for FreeSentral\nDefaults !requiretty\napache env_reset,!syslog,ALL=NOPASSWD: /usr/libexec/freesentral/ctl-root' >> "$f"
    RETVAL=1
fi

## Activate the auto vacuum in PostgreSQL
f="/var/lib/pgsql/data/postgresql.conf"
if ! fgrep -q 'FreeSentral' "$f"; then
    cat <<EOF >> "$f"

# generated by FreeSentral - please do not delete this line
stats_start_collector = on
stats_row_level = on
autovacuum = on
autovacuum_naptime = 300
EOF
    RETVAL=1
fi

## Allow Apache to write to the wanpipe config directory
f="/etc/wanpipe"
if [ -d "$f" ]; then
    if [ X`stat -c '%U' "$f" 2> /dev/null` != "Xapache" ]; then
	RETVAL=1
	chown -R apache.root "$f" 2> /dev/null || RETVAL=2
    fi
else
    RETVAL=2
fi

exit $RETVAL
